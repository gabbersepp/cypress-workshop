<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>reveal.js</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/black.css" id="theme">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css" id="highlight-theme">
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section data-markdown>
					<textarea data-template>
						![](./own_assets/cypress.png)
					</textarea>
				</section>
				<section data-markdown>
					<textarea data-template>
						## Organisatorisches
						+ Mittagspause 12:00 bis 13:00
						+ Zu jeder vollen Stunde 10 Minuten Pause

					</textarea>
				</section>

				
				<section>
					<section>
					<h2>Über mich - Josef Biehler</h2>
					<div style="float:left; width: 70%">
						<ul>
							<li>Wirtschaftsinformatik Bachelor</li>
							<li>Angestellt bei Samhammer AG, Weiden</li>
							<li>Fullstack Entwickler</li>
							<li>.NET Backend mit Aurelia Frontend</li>
							<li>UI Tests / API Tests</li>
							<li>Zeichnen, Programmieren, Bloggen</li>
							<li>Seit Neuestem: Alles rund ums Haus :-)</li>
						</ul>
					</div>
					<img src="own_assets/me.png" style="width: 25%">
					</section>
					<section>
						<h2>Social media</h2>
						<ul>
							<li>https://biehler-josef.de</li>
							<li>https://kack.dev</li>
							<li>https://www.instagram.com/josefbiehler/</li>
							<li>https://twitter.com/JosefBiehler</li>
							<li>https://twitter.com/KackDev</li>
							<li>https://github.com/gabbersepp</li>
							<li>https://dev.to/gabbersepp</li>
						</ul>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Code
							+ https://github.com/gabbersepp/cypress-workshop

						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Ablauf
							+ Cypress zeigen mit einfachen Beispielen
							+ Dann: Umsteigen auf unsere Applikation
							
						</textarea>
					</section>
				</section>
				
				<section>
					<section data-markdown>
						<textarea data-template>
							## Start
							```js
							npm init
							npm install cypress@7.3.0
							```
							Zwei NPM Scripts anlegen:
							```js
							"scripts": {
								"cy-open": "cypress open",
								"cy-run": "cypress run",
								"cy-run-single": "cypress run --spec cypress/integration/temp.spec.js"
							}
							```
						
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Konfiguration
							*cypress.json* im Rootverzeichnis anlegen:
							```js
							{
								"baseUrl": "http://biehler-josef.de:9500/HD",
								"defaultCommandTimeout": 30000
							}						
							```
							## Verzeichnisse
							- */cypress/integration*
							- */cypress/plugins*
							- */cypress/support*
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Startprojekt
							[https://github.com/gabbersepp/cypress-workshop/tree/master/startproject](https://github.com/gabbersepp/cypress-workshop/tree/master/startproject)
							+ *npm install* nicht vergessen
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## VS Code templates
							+ Gerade für Neueinsteiger im Team
							+ Hürden abbauen
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Plugins
							- Ausführung im Node Prozess
	
							```js
							module.exports = (on, config) => {
							}
							```
	
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Support
							- Einmalig ausgeführt in Browser
							- Globale Konfig, Commands, etc
	
							```js
							// leer
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Erster Test
							```js
							describe("erster test", () => {
								it("blabla", () => {
									cy.visit("https://samhammer.de");
									cy.get("body").should("contain", "Samhammer");
								})
							})
							```

						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Erster Start
							```
							npm run cy-open
							```

						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## interaktiver Modus
							+ Snapshot pro Command
							+ kann jederzeit betrachtet werden
							+ Achtung: Speicherhungrig!
	
							<aside class="notes">
								UI zeigen, rumspielen, fehlschlagen lassen
							</aside>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Erster Start
							```
							npm run cy-run
							```
	
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Tipp: Cypress Cache aufräumen
							+ jede Cypress Version benötigt etwa 600MB
							+ C:/Users/jbiehler/AppData/Local/Cypress/Cache
							+  ```cypress cache prune```
							+ oder einfach Ordner löschen ;-P
						</textarea>
					</section>
				</section>

				<section>
					<section data-markdown>
						<textarea data-template>
							## Assertions
							+ Chai assertions
							+ BDD & TDD Syntax

							```js
							// BDD:
							expect(name).to.not.equal('Jane')
							expect(arr).to.have.any.keys('age')
							expect(5).to.be.lessThan(10)

							// TDD:
							assert.notEqual(3, 4, 'vals not equal')
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Assertions - Should
							+ Cypress Command um Assertions auszuführen
							+ Should + Chai Assertion möglich
							+ Should aber auch mit Callback
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Einschub - Cypress = Asynchron
							+ Cypress nutzt Promiseähnliches Konstrukt
							+ Cypress Commands geben "Chainable" Objekt zurück
							+ Ergebnis von cy.get(...) kann also nicht direkt verarbeitet werden, sondern nur mit weiteren Commands
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Assertions - Should mit Chai Assert
							+ Assert auf das vorherige Element
							+ hier kann exakt der Gleiche Chai Assert benutzt werden
							
							```js
							cy.get("body").should("contain", "Test")
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Assertions - Should callback
							```js
							cy.get(..).should($e => {
								// Logik und Asserts
							})
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Assertions
							+ Kombination mit "and"

							```js
							describe("assertions", () => {
								it("test", () => {
									cy.wrap({ test: 1 }).should("have.any.keys", "test")
										.and("not.have.any.keys", "blabla")
								})
							});
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Assertions
							Cypresscommands haben Defaultassertions

							```js
							cy.get("body123") // impliziert: should("exist")
							```

						</textarea>
					</section>
					
					<section data-markdown>
						<textarea data-template>
							## Assertions
							Default assertions werden übersprungen

							```js
							cy.get("body123").should("not.exist")
							```
						</textarea>
					</section>

					<section data-markdown>
						<textarea data-template>
							## not.visible vs not.exists
							```js
							cy.get("nicht-vorhanden").should("not.visible")
							```
							+ führt zu Fehler
							+ nicht vorhandene Elemente können nur mit "not.exists" geprüft werden
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Weitere Selektorfunktionen
							+ find()
							```js
							cy.get("body").find("div")
							```
							+ last()
							```js
							cy.get("li").last()
							```
							+ first()
							```js
							cy.get("li").first()
							```
							+ contains()
							```js
							cy.visit("https://google.de").get("body").contains("Google Suche")
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Interaktion
							+ type()
							```js
							cy.get("input").type("bla{del}bla")
							```
							+ click()
							```js
							cy.get("button").click()
							```
							+ focus()
							```js
							cy.get("input").focus()
							```
						</textarea>
					</section>

					<section data-markdown>
						<textarea data-template>
							## Selektoren bestimmen
							+ manchmal schwierig, wenn Elemente Fokus verlieren
							+ da hilft: interaktive Modus und DOM Snapshots!
						</textarea>
					</section>

					<section data-markdown>
						<textarea data-template>
							## Demo

							<aside class="notes" data-markdown>
								get, first, last, focus, type, click, wrap

								Beispiel mit should cb
								
								Z.b. toastermeldung, welche verschwindet, im HD zeigen?

								```
								cy.visit("http://biehler-josef.de:9500/HD/#/ticket/635");
								cy.get("#actionButton_views\\.Ticket\\.ActionButtons\\.Save").click()
								```
							</aside>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Übung 1
							+ https://docs.cypress.io/ aufrufen
							+ nach "cy.type" suchen
							+ Suchergebnis anklicken

							## Übung 2
							+ https://docs.cypress.io/ aufrufen
							+ Prüfen ob Text von jedem H3 größer 0 ist
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Lösung 1
							```js
							it("cy.type", () => {
								cy.visit("https://docs.cypress.io/")
								cy.get('.DocSearch-Button-Placeholder').click();
								cy.get('#docsearch-input').type('cy.type').wait(1000);
								cy.get('.DocSearch-Hit').first().click();
							})
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Lösung 2
							```js
							it("h3", () => {
								cy.visit("https://docs.cypress.io");
								cy.get("h3").then($divs => {
									for(let i = 0; i < $divs.length; i++) {
										expect($divs[i].textContent.length).greaterThan(0)
									}
								})
							})
							```
						</textarea>
					</section>
				</section>

				<section>
					<section data-markdown>
						<textarea data-template>
							## Retryability
							- Manche Commands sind wiederholbar
							- Es wird solange wiederholt bis Check erfolgreich oder Timeout abgelaufen ist
						
							```js
							it("get() und should() wird wiederholt", () => {
								setTimeout(() => {
									const div = document.createElement("div");
									div.id="newdiv";
									div.textContent = "ASD";
									Cypress.$("body").append(div);
								}, 5000);
						
								cy.get("#newdiv").should($e => {
									console.log(`Length: ${$e.length}`);
									expect($e.length).greaterThan(0);
								});
							})
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>	
						![](./own_assets/retry.png)
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## then vs. should
							+ should: retryable
							+ then: nicht
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							```js
							it("nicht alles ist repeatable", () => {
								let i = 0;
								cy.get("body").then($e => {
									console.log(i++);
									expect(i).to.eq(2);
								});
							});

							
							it("nicht alles ist repeatable - fix", () => {
								let i = 0;
								cy.get("body").should($e => {
									console.log(i++);
									expect(i).to.eq(2);
								});
							})
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							![](./own_assets/thenshould.png)
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Should + Command = vorsicht
							```js
							it("should + command = vorsicht", () => {
								cy.get("body").should($body => {
									cy.get("body")
								})
							})
							```		

							![](./own_assets/shouldvorsicht.png)
						</textarea>
					</section>

					<section data-markdown>
						<textarea data-template>
							## Videos und Screenshots
							Cypress macht automatisch Videos & Screenshots
						</textarea>
					</section>

					<section data-markdown>
						<textarea data-template>
							## Eigene Screenshots
							+ mit ```cy.screenshot``` command
							+ auch auf einzelne Elemente möglich

							```js
							cy.get("button").screenshot()
							```
						</textarea>
					</section>

					<section data-markdown>
						<textarea data-template>
							## Eigene Screenshots
							+ ermöglichen Visuelle Tests
							+ !! Screenshots unterscheiden sich (Environment, run, open)
						</textarea>
					</section>

					<section data-markdown>
						<textarea data-template>
							## Debuggen
							+ Am besten per ```debugger``` Statement
						</textarea>
					</section>

					<section data-markdown>
						<textarea data-template>
							## Auf Promises wird gewartet
							
							```js
							it("Auf Promises wird gewartet", () => {
								const promise = new Promise(resolve => 
									setTimeout(() => resolve("fertig"), 5000))

								cy.then({ timeout: 10000 }, () => promise)
									.then(result => expect(result).to.eq("fertig"))  
							})
							// geht auch mit wrap:
							const promise = new Promise(resolve => setTimeout(() => resolve({
								fn: () => "test"
							}), 5000))
					
							cy.wrap(promise).invoke("fn").should("contain", "test")
							```
						</textarea>
					</section>

					<section data-markdown>
						<textarea data-template>
							## Asynchronität
							+ Cypresscommands landen in Queue
							+ Folge: Asynchronität
	
							```js
							// falsch:
							let $element = null;
							cy.get("body").then($e => $element = $e);
							expect($element).not.null;

							// richtig:
							let $element = null;
							cy.get(".add-tab-btn")
								.then($e => $element = $e)
								.then(() => expect($element).not.null)
							```
						</textarea>
					</section>
						
					<section data-markdown>
						<textarea data-template>
							## Asyncronität => kein await möglich

							```js
							const body = await cy.get("body");
							const text = body.text();
							// "funktioniert"
							expect(text).contain("Google");
							
							// aber was ist damit:
							cy.get("form[action*='search'] input[type='text']")
								.type("biehler-josef.de");
							const result = await cy
								.get("*[class*='__suggestions-inner-container']");

							// schlägt fehl
							expect(result.length).greaterThan(0);
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Demo

							<aside class="notes">
								+ mittels fetch() Daten laden: https://testimonialapi.toolcarton.com/api
								+ debugger um daten anzuschauen
								+ irgendeinen assert
								+ fehlschlagen lassen -> Screenshot
								+ Video
							</aside>
						</textarea>
					</section>
				</section>
				<section data-markdown>
					<textarea data-template>
						## Doku
						https://docs.cypress.io/
						Sehr ausführlich
						
						## Beispiele
						https://github.com/cypress-io/cypress-example-recipes

						## Blog
						https://www.cypress.io/blog/
						https://glebbahmutov.com/blog/

					</textarea>
				</section>
				
				<section data-markdown>
					<textarea data-template>
						## FirstAnswer HD
						+ Aurelia Frontend
						+ .NET Backend

						![](./own_assets/hd.jpg)
					</textarea>
				</section>

				<section>
					<section data-markdown>
						<textarea data-template>
							## Login
							+ in HD: Speicherung des Access Tokens in localStorage
							+ möglich über die GUI
							
							```js
							cy.visit("/#/login");
							cy.get("#usernameinput").type("developer");
							cy.get("#passwordinput").type("Test12");
							cy.get("#loginbutton").click();
							cy.get(".add-tab-btn").should("exist");
							```

							Aber nicht sinnvoll
							+ man würde immer etwas testen, was man gar nicht testen will	
							
						</textarea>
					</section>

					<section data-markdown>
						<textarea data-template>
							# Login
							+ besser mittels Request und Manipulation localStorage
							+ Code ist bereits im Startprojekt hinterlegt: *cy.login()*

							<aside class="notes" data-markdown>
								mit fetch() oder axios etc kann gearbeitet werden
							</aside>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## cy.request vs fetch
							+ cy.request der natürliche Weg
							+ Aber: fetch() für generische Lösung
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Demo

							<aside class="notes" data-markdown>
								mit fetch() / request / axios() irgendeinen request machen und drauf warten
								nicht im HD
								https://testimonialapi.toolcarton.com/api
								fetch achtung: gibt es nicht unter nodejs, wir nutzen axios
							</aside>
						</textarea>
					</section>
				</section>
				<section>
					<section data-markdown>
						<textarea data-template>
							## Login als Custom Command?
							+ erweitert Cypress
							+ kann auf Chainable Objekte aufgerufen werden
							+ oder nur auf das globale Cy Objekt
							+ sinnvoll, wenn oft aufgerufen

							```js
							// parent command
							Cypress.Commands.add("login", (email, password) => { ... })
							// child command --
							Cypress.Commands.add("drag", { prevSubject: 'element'}, (subject, options) => { ... })
							// dual command --
							Cypress.Commands.add("dismiss", { prevSubject: 'optional'}, (subject, options) => { ... })
							```
							<aside class="notes" data-markdown>
							Die Beispiele oben aus der Cypress Doku kopiert
							</aside>
						</textarea>
					</section>

					<section data-markdown>
						<textarea data-template>
							## Custom Command repeatable?
							+ Beispiel: Command das eine Zufallszahl prüft
							+ Nützlich: ```cy.verifyUpcomingAssertions```
	
							<aside class="notes" data-markdown>
								Test: 27.retryable-command.spec.js

								```js
								describe("Custom command", () => {     
									const randomFn = (options = {}) => {
										const resolveValue = () => {
											return Cypress.Promise.try(() => {
												const z = Math.ceil(Math.random() * 10);
												Cypress.log({
													name: 'RandomFn',
													displayName: 'RandomFn',
													message: `Value: ${z}`,
													consoleProps: () => {
													  return {
														  devopenspace: `ist cool ${z}`
													  }
													}
												  })
												  return z;
											}).then(value => {
												return cy.verifyUpcomingAssertions(value, options, {
													onRetry: resolveValue
												})
											})
										}
										return resolveValue()   
									}
								
									Cypress.Commands.add("random", randomFn)
								
									it("test", () => {
										cy.random().should(z => {
											expect(z).to.eq(2);
										})
									})
								})
								```
							</aside>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Logging
							+ cy.log()
							+ Cypress.log

						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Logging in custom commands
							```js
							Cypress.log({
								name: 'Name des Logs',
								displayName: 'Anzeige in UI',
								message: `Nachricht`,
								consoleProps: () => {
								return {
									// das wird angezeigt, wenn man auf den Log klickt
									}
								}
							})
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Cypress.log vs cy.log
							+ Cypress.log ist kein asynchroner Command
							+ cy.log() schon
							+ cy.log() für "normale" Verwendungen
							+ Cypress.log() wenn keine asyncrone Vorgänge erlaubt sind
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Falsch
							
							```js
							it("test", () => {
								cy.wrap({ test: 1 }).should(obj => {
									cy.log("test")
									expect(obj.test).eq(1)
								})
							})
							```

							![](./own_assets/cy.log.falsch.png)
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Richtig

							```js
							it("test2", () => {
								cy.wrap({ test: 1 }).should(obj => {
									Cypress.log({
										name: 'test',
										displayName: 'test',
										message: `test`,
										consoleProps: () => {
										return {
											test: 1
											}
										}
									})
									expect(obj.test).eq(1)
								})
							})
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Cypress Logging Format
							```js
							cy.log("test")
							cy.log("**test**")
							cy.log("_test_")
							cy.log("[red]test")
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Debug & Pause
							+ manchmal ganz hilfreich

						</textarea>
					</section>

					<section data-markdown>
						<textarea data-template>
							## Child command
							```js
							Cypress.Commands.add("doesContain", { prevSubject: "element" }, (subject, options) => {
								cy.wrap(subject).should("contain", options)
							})
						
							it("test", () => {
								cy.visit("https://google.de").get("body")
									.doesContain("google");
							})
							```
						</textarea>
					</section>

					<section data-markdown>
						<textarea data-template>
							## Demo

							<aside class="notes" data-markdown>
								cy.log, Cypress.log, log format, custom commands alle drei varianten
							</aside>
						</textarea>
					</section>

					<section data-markdown>
						<textarea data-template>
							## Übung
							+ HD aufrufen
							+ Element "#usernameinput" anfordern
							+ should + callback nutzen
							+ prüfen, ob Element vorhanden ist
							+ nein -> Exception werfen, ja -> weiter im Text
							+ Element loggen
							+ prüfen, ob element attribut 'type' = 'text'

							```js
							...should($e => {
								// $e prüfen
								// $e loggen
								// assert
							})
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Lösung
							<pre><code data-line-numbers="5|6|7-11|12|15-22|24">
							describe("HD", () => {
								it("should be loaded", () => {
									cy.visit("/");
									cy.get("#usernameinput").should($e => {
										if ($e.length === 0) {
											Cypress.log({
												name: 'Element noch nicht da',
												displayName: 'Element noch nicht da',
												message: `Element noch nicht da`,
											});
											throw new Error();
										}
							
										Cypress.log({
											name: 'Element da',
											displayName: 'Element da',
											message: `Element da`,
											consoleProps: () => ({
												placeholder: $e[0].placeholder
											})
										});
							
										expect($e.attr("type")).to.eq("text")
									});
								})
							})
							</code></pre>
						</textarea>
					</section>
				</section>

				<section>
					<section data-markdown>
						<textarea data-template>
							## Problem: welcher Tab ist offen?
							+ Person, Company, CI, Ticket ??
							+ und v.A. welche Id ??
							+ wichtig bei: Klick auf beliebiges Ticket in Pool etc
							+ immer dann, wenn keine spezifische Entität geöffnet wird
						</textarea>
					</section>

					<section data-markdown>
						<textarea data-template>
							## Problem: welcher Tab ist offen?

							Was wir brauchen:
							+ cy.location() zum Auslesen der ID
							+ Locator für Element, um gewechselten Tab sicherzustellen					

							<aside class="notes" data-markdown>
								z.b. ticketroot xyz oder so
								damit man halt weis, dass im vergleich zu vorher nun ein anderes ticket gerendert wurde

								zeigen, wo in der location die ID ist und wo im DOM!!!!
							</aside>
						</textarea>
					</section>

					<section data-markdown>
						<textarea data-template>
							## Übung
							+ Parent command für "Neues Ticket" welches die ID bereit stellt

							## Tipps
							+ ID von Button: #shellnewticket
							```js
							Cypress.Commands.add(.....);
							```

						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							<pre><code data-line-numbers="2|3|4|6-12|13-16|17|27">
							Cypress.Commands.add("newTicket2", function() { // function!
								cy.location().its("hash").as("hash_old")
								cy.get("#shellnewticket").click();
								cy.location().then(loc2 => {
									if (loc2 === this.hash_old) {
										Cypress.log({
											displayName: "BlaBla",
											message: "hashes sind gleich"
										})
										throw new Error()
									}
									Cypress.log({
										displayName: "BlaBla",
										message: `Hash alt: ${this.hash_old}, neu: ${loc2.hash}`
									})
									const identifier = loc2.hash.match(/.*(n[0-9]+)/)[1];
									return identifier;
								})
							});							
							
							describe("test", () => {
								it("", () => {
									cy.login("developer", "Test12")
									cy.visit("/#/ticket/1")
									cy.newTicket2().then(id => {
										Cypress.log({
											displayName: "Ticket",
											message: "TicketId is " + id
										})
									})
								})
							})
							</code></pre>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Achtung
							+ Location abgleichen!
							+ should() kann den returnvalue nicht manipulieren

							<aside class="notes" data-markdown>
								Am Beispiel zeigen:
								cy.location().should(loc2 => {
									// ...
									return loc2.hash.match(....) -> geht nicht
								})
								// besser:
								cy.location().should(...).then(loc2 => ...)
								
								should() gibt den Wert zurück, den es bekommt
								hier ist then() ok, da der should vorher für Sicherheit gesorgt hat
							</aside>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Locator
							Nun können wir folgendes machen:
							<pre><code data-line-numbers="5">
							it("test2", () => {
								cy.login("developer", "test");
								cy.newTicket().then(id => {
									cy.get(`#Title${id} input`).type("test");
								})
							})
							</code></pre>

							Damit können wir mehrere Tickettabs geschickt ansprechen
						</textarea>
					</section>

					<section data-markdown>
						<textarea data-template>
							## Flyout nach "Neues Ticket"
							![](./own_assets/flyout.jpg)
							+ das stört weitere Interaktion mit der Seite
							+ "Einriffe" manchmal notwendig
						</textarea>
					</section>

					<section data-markdown>
						<textarea data-template>
							## Störende Elemente

							+ entfernen von unerwünschten Flyout
							+ entfernen von Cookiebannern
							+ entfernen von Fixed Elementen
							+ .....


							```js
							cy.get("body").then($e => $e.remove());
							// oder
							cy.get("body").click();
							```
						</textarea>
					</section>

					<section data-markdown>
						<textarea data-template>
							## Page object pattern
							+ Locator immer so zu schreiben ist nervig und Fehleranfällig
							+ unsere Lösung: Page Object (mehr oder weniger)
						</textarea>
					</section>

					<section data-markdown>
						<textarea data-template>
							![](./own_assets/pageobjectpattern.png)
						</textarea>
					</section>

					<section data-markdown>
						<textarea data-template>
							## Jetzt wird es hässlich - Select2
							+ Auswahl von Kategorie

							```js
							cy.newTicket();
							cy.get("#Categoryn0").click();
							// geht nicht :-(
							```

							<aside class="notes" data-markdown>
								+ wurde mittlerweile ausgetauscht
								+ zeig trotzdem kurz den Code
								+ Select Bibliothek, kacke und so
							</aside>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Umgang mit Select2
							+ Manche Libs machen die Testinteraktion schwierig
							+ siehe Code...
						</textarea>
					</section>
				</section>
				<section>
					<section data-markdown>
						<textarea data-template>
							## Probleme zwischen Tests innerhalb einer Datei
							+ Cypress bereinigt State zwischen Tests
							+ aber kein Reset der App
							+ kein Reset von laufenden Requests!
						</textarea>
					</section>
					<section>
						<pre><code data-trim data-noescape data-line-numbers="1-7|9-16|18-27|29-33">
							it("Cypress bereinigt state zwischen tests", () => {
								localStorage.setItem("blabla", "wurst");
							})
						
							it("deshalb ist der localstorage leer", () => {
								expect(localStorage.getItem("blabla")).to.be.null;
							})
						
							it("aber Cypress bereinigt nicht die App", () => {
								cy.get("body").then($b => {
									const div = document.createElement("div");
									div.id = "newitem";
									div.textContent = "test content";
									$b.append(div);
								})
							})
						
							it("wie man sieht", () => {
								cy.get("#newitem").should("contain", "test content");
							})
						
							it("das führt zu problemen -> nur schnell die App öffnen", () => {
								cy.login("developer", "Test12");
								cy.newTicket();
								cy.newTicket();
								cy.newTicket();
							})
						
							// hier bereinigt Cypress localStorage, Cookies, ....
						
							it("und nochmal", () => cy.login("developer", "test"))
						
							// wie fixen? kA, liegt teils auch am AUT Code
						</code></pre>
					</section>
					<section data-markdown>
						<textarea data-template>
							![](./own_assets/state.png)
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Probleme zwischen Tests - Lösungen
							+ ein reload() am Anfang schafft Abhilfe
							+ Cypress hat das ebenfalls auf dem Schirm
							+ Ist es überhaupt ein Problem?

							<aside class="notes" data-markdown>
								ABER: Kostet Zeit!!
							</aside>
						</textarea>
					</section>
				</section>
				<section>
					<section data-markdown>
						<textarea data-template>
							## its
							+ cy.its("...") ruft das Feld mit dem entsprechenden Namen ab
							+ cy.its() ist auch repeatable
							
							```js
							describe("Its", () => {
								it("repeatable", () => {
									var obj = {
										get test() {
											console.log("retry");
											return 1;
										}
									}
									cy.wrap(obj).its("test").should("eq", 2);
								})
							})
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## its
							![](./own_assets/its.png)
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							<h2>Cypress Context</h2>
							<ul><li>Vergleich der zwei Hashes bei Login</li></ul> 
	
							<pre><code data-trim data-noescape data-line-numbers="4-5">
							Cypress.Commands.add("newTicket", () => {
								cy.location().its("hash").as("loc");
								cy.get("#shellnewticket").click().get("body").click();
								cy.location().should(function(loc2) {
									expect(this.loc).not.eq(loc2.hash);
								}).then(loc2 => {
									const identifier = loc2.hash.match(/.*(n[0-9]+)/)[1];
									return identifier;
								})
							 });
							 </code></pre>
	
							 <ul>
								 <li>spart eine Einrückungsebene</li>
								 <li>erfordert aber <i>function</i> Syntax</li>
							 </ul>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Bedingte Prüfung
							+ wenn xyz dann mach dies oder jenes
							+ Achtung: Nicht unbedingt Best Practices, aber in Praxis notwendig
							+ hilfreich: .then($e => ....) => JQuery!
						</textarea>
					</section>

					<section data-markdown>
						<textarea data-template>
							## Übung
							+ Checkbox anhacken
							+ möglichen vorherigen Status beachten
							+ ggf neue Person anlegen

							<aside class="notes" data-markdown>
								Neue person um konflikte zu vermeiden
							</aside>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							<pre><code data-line-numbers="9-13">
							describe("should", () => {
								it("test", () => {
									cy.login("developer", "Test12")
									cy.visit("http://biehler-josef.de:9500/HD/#/person/5");
									cy.get("div").contains("Neues System Feld 1").parent().find("input-check-box-component").wait(500)
									.then($e => {
										debugger;
										if ($e.find("img[src*='CheckBox_No']").length > 0) {
											cy.wrap($e).click();
										} else if ($e.find("img[src*='CheckBox_Yes']").length > 0) {
											// do nothing                
										}
									})
								})
							})
							</code></pre>
						</textarea>
					</section>

					<section data-markdown>
						<textarea data-template>
							## Bedingte Prüfung - Lösung
							+ Cypress baut nur auf JQuery auf
							+ innerhalb von then/should kann ALLES getan werden, was auch mit JQuery geht

							<pre><code data-trim data-noescape data-line-numbers="7,9">
								describe("should", () => {
									it("test", () => {
										cy.login("developer", "Test12");
										cy.visit("http://biehler-josef.de:9500/HD/#/person/5");
										cy.get("div").contains("Vielleicht").parent()
											.find("input-check-box-component").wait(500)
										.then($e => {
											if ($e.find("img[src*='CheckBox_No']").length > 0) {
												cy.wrap($e).click();
											} else if 
												($e.find("img[src*='CheckBox_Yes']").length > 0) {
												// do nothing                
											}
										})
									})
								})
							</code></pre>
						</textarea>
					</section>
				</section>
				<section>
					<section data-markdown>
						<textarea data-template>
							## "Meine letzten Tickets" prüfen
							+ passt die Datumsanzeige "vor etwa x Stunden"
							+ wie umsetzen?
							+ Daten erzeugen -> zu jung
							+ drauf verlassen, dass da schon Tickets da sind -> zu instabil
							+ Datumswerte in DB faken -> zu viel verknüpfte Daten

						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Lösung: Requests mocken
							+ cy.intercept()

						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							### Requestergebnis beeinflussen

							<pre><code data-line-numbers="5">
							it("test", () => {
								cy.login("developer", "Test12");
								cy.visit("http://biehler-josef.de:9500/HD");
								cy.intercept("GET", /.*GetPerson.*/i, {"address":{"city":"Arsch der Welt","zipCode":"92648","addressLine":"blablabla","id":5},"company":null,"addressId":5,"companyId":null,"title":"Default.DataSources.Titles.Male","firstName":"1619530006083 Max","lastName":"1619530006083 Mustermann","language":null,"country":null,"eMail":"1619530006085@firstanswerdev.de","phoneNumber":null,"faxNumber":null,"eMails":[{"value":"1619530006085@firstanswerdev.de","isPrimary":true,"id":8}],"phoneNumbers":[],"faxNumbers":[],"externalReference":null,"hdcLoginAvailable":false,"id":5,"additionalPersonInfo":null,"gid":null,"customerNumber":"1234","lastImportDate":null,"c87abe0c-9075-45f1-a35d-2094eb314327":null,"765905ba-9f2c-472a-83fc-de0a09c0db55":null})
								cy.visit("http://biehler-josef.de:9500/HD/#/person/5");
								cy.wait(50000);
							})
							</code></pre>

							<aside class="notes">
								Request erreicht Server gar nicht
								Mit Breakpoint zeigen?
							</aside>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							### Requestergebnis beeinflussen
							![](./own_assets/arschderwelt.png)
						</textarea>
					</section>
					<section  data-markdown>
						<textarea data-template>
							### Große JSON Objekte
							+ was, wenn ich nur einen Wert ändern möchte, ohne dafür das ganze Objekt anzugeben?
							+ Request senden und response bearbeiten
							<pre><code>
							cy.login("developer", "Test12");
							cy.visit("http://biehler-josef.de:9500/HD");
							cy.intercept("GET", /.*GetPerson.*/i, r => {
								r.reply(interceptor => {
									interceptor.body.address.city = "Arsch der Welt";
								})
							});
							cy.visit("http://biehler-josef.de:9500/HD/#/person/5");
							cy.wait(50000);
							</code></pre>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							### Auf Request warten
							+ Sinnvoll!

							<pre><code data-line-numbers="11">
							cy.login("developer", "Test12");
							cy.visit("http://biehler-josef.de:9500/HD");
							cy.intercept("GET", /.*GetPerson.*/i, r => {
								r.reply(interceptor => {
									interceptor.body.address.city = "Arsch der Welt";
								})
							}).as("getperson");
							cy.visit("http://biehler-josef.de:9500/HD/#/person/5");
							cy.wait("@getperson").then(r => {
								assert.equal(r.response.body.address.city, "Arsch der Welt")
							});
							</code></pre>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							### TicketPool mit unterschiedlichen Filtern testen
							+ Daten mocken abhängig vom Requestbody

							<pre>
								<code data-line-numbers="1-5|6-20|22-36|41-46|48-52|54-57">	
const response = {
	moreItemsAvailable: false,
	totalRowCount: 1
}
const tOpen = {"id":"676","type":"Ticket","selected":false,"data":{"aggregatedColumn_Ticketinfo":{"id":676,"title":"Ticket status offen","waitingStatus":"Default.DataSources.WaitingStatuses.NotWaiting","waitingReason":null,"waitingStatusUntil":null,"creationDate":"2021-04-30T07:21:32Z","status":"Default.DataSources.TicketStatuses.Open","category":"Test.Categories.NonRrpsAgPortfolio","assignedToId":1017,"assignedTo":"TestUser autoAgent2_team1","email":null,"reportedBy":{"person":{"firstName":"","lastName":"Samhammer","companyName":null},"company":null},"ticketInfoIcon":"User","ticketInfoIconTooltip":"userIconTicket","reminderProcessActive":false,"reminder":{"reminderKey":null,"currentReminderStep":0,"totalReminderSteps":0},"isNewInTeam":false,"slaInfo":{"isEscalated":true,"escalationInfoTooltip":"someSlasEscalated","runningSLAs":4,"escalatedSLAs":1},"isSubscribed":false},"column_ticket_Priority":"Test.ATD.SLAConfigurations.TicketSLAConfigurationOne.TicketPriorities.Standard","aggregatedColumn_Sla":{"slaRemainingTime":9692735.6005,"slaEndingDate":"2021-05-20T11:21:32Z","slaTranslationKey":"Test.ATD.SLACriteria.InterStatusTime","slaIsOverdue":true},"aggregatedColumn_Lastprocessing":{"assigneeName":"TestUser autoAgent2_team1","date":"2021-04-30T07:21:32Z","action":null,"workflowKey":null}}};
const tInprocessing = {
	type: "Ticket",
	selected: false,
	id: "2",
	data: {
		...tOpen.data,
		aggregatedColumn_Ticketinfo: {
			...tOpen.data.aggregatedColumn_Ticketinfo,
			id: 2,
			title: "ticket in bearbeitung",
			assignedToId: 20,
			assignedTo: "Josef Biehler",
		}
	}
}
cy.intercept("POST", /.*loaddata.*/i, req => {
	const filter = req.body.filter[0];
	if (filter && filter.filterKey === "status" && 
		filter.values.indexOf("Default.DataSources.TicketStatuses.Open") >= 0) {
			req.reply({...response, items: [tOpen]})
	} else if (filter && filter.filterKey === "processingStatus" 
		&& filter.values.indexOf("inProcessing") >= 0) {
			req.reply({...response, items: [tInprocessing]})
	} else {
		req.reply({
			moreItemsAvailable: false,
			totalRowCount: 0
		})
	}
}).as("loaddata");

cy.login("developer", "Test12");
cy.visit("http://biehler-josef.de:9500/HD/#/pool/")

// initialer aufruf -> status offen
cy.wait("@loaddata");
cy.get("#ticketPoolResultTable")
	.should("contain", "Ticket status offen");
cy.get("#ticketPoolResultTable .generic-table-row")
	.its("length").should("eq", 1);

// status filter entfernen
cy.get(".clear-multiselect abbr").click().wait("@loaddata");
// "In Bearbeitung" Filter
cy.get("#processingStatusFilter .choices").click()
	.get(".choices__list").contains("In Bearbeitung").click();

cy.get("#ticketPoolResultTable")
	.should("contain", "ticket in bearbeitung");
cy.get("#ticketPoolResultTable .generic-table-row")
	.its("length").should("eq", 1);    
								</code>
							</pre>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Auf x. Request warten
							+ z.b. zweiten loadData Request
							+ möglich durch nummerisches Suffix im alias

							```js
							cy.intercept("POST", /.*loadData.*/).as("loadData");
							cy.login("developer", "Test12").then(() => {
								cy.visit("http://biehler-josef.de:9500/HD/#/pool/")
								cy.get("#generic-pool-result-view .refresh").click()
								cy.wait("@loadData.2");
							})
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Demo
							
							<aside class="notes" data-markdown>
								```js
								describe("Last edited tickets", () => {
									beforeEach(() => {
										const d = new Date();
										d.setHours(d.getHours()-15);
									
										cy.intercept("GET", /.*GetLastEditedTickets.*/, [
											{
												lastActionDate: d.toISOString(),
												ticket: {
													id: 1234,
													title: "test ticket",
													category: "test kategorie"
												}
											}
										])
										cy.login("developer", "Test12");
									});
									
									it("should show date string", () => {
										const dateSr = "Letzter Zugriff vor etwa 15 Stunden";
										cy.get(".last-edited-tickets-list").should("contain", dateSr);
									});
								})
								```
							</aside>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Fixtures
							+ Daten auf diese Weise zu mocken kann nervig sein
							+ evtl besser: Fixtures
							+ Standardverzeichnis: "cypress/fixtures"

							<pre><code data-line-numbers="6">
							[
								{
									"lastActionDate": "2020-11-13T19:13:28.748Z",
									"ticket": {
										"id": "1234-ticketid",
										"title": "test ticket",
										"category": "test kategorie"
									}
								}
							]	
							</code></pre>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Fixtures
						
							<pre><code data-line-numbers="7,8,13,14">
								describe("Last edited tickets", () => {
									beforeEach(() => {
										const d = new Date();
										d.setHours(d.getHours()-15);
									
										cy.intercept("GET", /.*GetLastEditedTickets.*/, 
											{ fixture: "test.json" })
										cy.login("developer", "Test12");
									});
									
									it("should show date string", () => {
										cy.get(".last-edited-tickets-list")
											.should("contain", "1234-ticketid");
									});
								})
							</code></pre>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Fixtures - cy.fixture()
							+ Daten können ebenfalls über cy.fixture() geladen werden

							```js
							it("test2", () => {
								cy.fixture("test.json").then(f => {
									debugger;
								})
							})
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Problem: Testen, dass Request nicht kommt
							+ Szenario: Feldvorschläge
							+ Keine Vorschläge bei bestehendem Ticket
							+ Idee: try/catch

							![](./own_assets/spideragent.png)
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							<pre><code data-line-numbers="6-10">
							it("try/catch", () => {
								cy.server();
								cy.route("POST", /.*getFieldRecommendationsFromText.*/).as("request");
								cy.login("developer", "Test12");
								try {
									cy.visit("http://localhost/HelpdeskApp/#/ticket/1").wait("@request");
								} catch {
									
								}
							})
							</code></pre>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Problem: Testen, dass Request nicht kommt
							+ Richtiger Weg: cy.on("error")
							+ mit cy.on() auf Events lauschen
							+ https://docs.cypress.io/api/events/catalog-of-events.html 

							![](./own_assets/feldvs.jpg)
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							```js
							it("cy.on", done => {
								cy.on("fail", error => {
									if (error.name === "CypressError"
										&& error.message.toString()
														.match(/.*timed out waiting `.*` for the 1st request to the route: `classifierRequest`.*/)) {
											// calling done forces cypress to turn test to green
											done();
									}
								});
						
								cy.intercept("POST", /.*getFieldRecommendationsFromText.*/).as("classifierRequest");
								cy.login("developer", "Test12");
								cy.visit("http://biehler-josef.de:9500/HD/#/ticket/1").wait("@classifierRequest");
							})
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Aber Achtung
							+ Aufruf von done() ermöglicht nicht das zurückkehren an den Ort der Exception

						</textarea>
					</section>
					<section data-markdown>
						<section data-template>
							## Übung
							+ Auf Request *getTicket* warten
							+ *title* des Tickets auf *Spartakiade* abändern
							+ http://biehler-josef.de:9500/HD/#/ticket/1 aufrufen
							+ Tickettitel abprüfen
						</section>
					</section>
					<section data-markdown>
						<textarea data-template>
							```js
							describe("test", () => {
								it("test", () => {
									cy.login("developer", "Test12");
									cy.intercept("GET", /.*getTicket.*/i, req => {
										req.continue(interceptor => {
											interceptor.body.title = "Spartakiade";
										})
									})
									cy.visit("/#/ticket/1")
										.get("#Title1 input").should("have.value", "Spartakiade")
								})
							})
							```
						</textarea>
					</section>	
					<section data-markdown>
						<textarea data-template>
							## Requests mocken - Fazit
							+ auf Request warten ist essentiell in SPA
							+ Mittels Bearbeiten der Configuration kann der Client gezielt gesteuert werden, ohne viel Code mocken zu müssen
							+ Beispiel: Feldvorschläge

							```js
							loginThroughAPI(null, ctx, {
								modifyClientConfig: (c: ApplicationConfig): void => {
								c.classifierEnabled = true;
							}});
							```
						</textarea>
					</section>
				</section>
				<section>
					<section data-markdown>
						<textarea data-template>
							## HDA Navigation: Sind alle Links klickbar?
							+ ablösen von manuellem Test: Durchklicken durch komplette Navigation
							+ jeden Link anklicken und Überschrift prüfen
							+ aber was bei Submenüs?
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## HDA Navigation: Lösung
							+ Geschickte Kombination von Cypress & JQuery

							<pre><code data-line-numbers="4|5|6|9-11|12-17">
							let header = "dummy value";

							cy.get("#mainSideBar li:has(a):not(:has(.fa-external-link))").each($e => {
								const link = cy.wrap($e);
								link.click();
								const $subMenu = $e.find("li");
					
								if ($subMenu.length > 0) {
									cy.wrap($subMenu).should("be.visible");
								} else {
									cy.get(".container-fluid.page-heading").should($header => {
										const headerText = $header.text();
										expect(headerText).not.equal(header);
										expect(headerText.length).greaterThan(1);
										header = headerText;
									});
								}
							});
							</code></pre>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Ticketweiterleitung testen
							+ Ticket in Team1
							+ Weiterleitung zu Team2
							+ IsNewInTeam wird auf true gesetzt nach einer gewissen Zeit
							+ Asynchron!
							+ Test wird flaky

							![](./own_assets/teamchanged.png)
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Asynchronität in App testen - Erster Versuch
							<pre><code data-line-numbers="3-21">								
							it("test", () => {
								let ticket;
								cy.login("developer", "Test12")
									.then(async () => ticket = await createTicket("test"))
									.then(() =>cy.visit("/#/ticket/" + ticket.id))
									.then(() => {
										cy.get("#actionButton_views\\.Ticket\\.ActionButtons\\.StopEditing").click();
										cy.get("*[id*=stopProcessing_changeTeamTicketAction]").click();
										openSelect2("*[data-ui-locator*=teamwidget] div.select2-container", "1st Level Support");
										cy.get("*[id*=changeTeamInvolvingAction]").choicesSelect("Ticket abschließen")
										cy.get("*[id*=changeTeamInvolvingAction] .label.with-clear").should("contain", "Ticket abschließen");
										cy.get("#actionButton_views\\.Ticket\\.ActionButtons\\.SaveChangeTeam").click();
									})
									.then(() => ticketPool(ticket.title))
									.then(d => {
										let isNewInTeam = d.items.find(x => x.id == ticket.id).data["aggregatedColumn_Ticketinfo"].isNewInTeam;
										expect(isNewInTeam).eq(true)
									});
							})
						</code></pre>

							<aside class="notes" data-markdown>
								Auf Code eingehen
								+ Pattern "ticket = " laut Cypress unschön, aber es funktioniert
								+ aber: Aufpassen, dass "ticket" nicht zu früh referenziert wird!
								+ choicesSelect(): Kleine Funktion um mit Dropdown ukzugeehh -> veraltet
								+ force: true: verhindert unerwünschtes scrollen etc, aber: Kein Sichtbarkeitscheck!
								+ choices selectoren: mancmhaml try/error um korrekte rauszufinden
								+ check auf labek: Um sicherzugehen, dass Aurelia seinen JKob getan hat
								+ Test ist jetzt flakky
								+ Cyprewss kann nicht wissen, wann Aktion verarbeitet wurde
								+ Flakky tests lassen sich leider nicht vermeiden, aber können behoben werden
							</aside>
						</textarea>
					</section>	
					<section data-markdown>
						<textarea data-template>
							## Asynchronität testen
							+ Möglichkeit 1: Wait()
							+ Allerdings Schlecht -> Testlaufzeit
							+ Möglichkeit 2: Warten bis Aktion verarbeitet ist
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Asynchronität testen - App anpassen
							+ App mit spezifischem Code anreichern, um Testen zu erleichtern

							```js
							export function waitUntilActionIsProcessed(systemAction, ticketId) {
								function check() {
									return get("http://biehler-josef.de:9500/api/
										AutomaticTestSupport/IsActionProcessed", 
											{ systemAction: systemAction, 
												ticketId: ticketId });
								}
							
								return repeat(400, 250, () => check(this));
							}
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Metadaten erzeugen?
							+ Testen, ob InvolvingAction auftaucht bei Teamwechsel
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Metadaten erzeugen?
							<pre><code data-line-numbers="2-14|19-33|35|39-42|44-45">
function provideMetadata(data, identifier) {
    return cy.token().then(t => {
        return cy.request({
            method: "POST",
            url: `http://biehler-josef.de:9500/api/AutomaticTestSupport/ProvideCustomMetadata?identifier=${identifier}`,
            headers: {
                "Authorization": "Bearer " + t,
                "X-Auth-ClientId": "local-test-hd"
            },
            body: data
        })
    });
}

describe("Involving Actions", () => {
    it("test", () => {
        cy.login("developer", "Test12");
        provideMetadata({
            allColumns: [],
            involvingActions: [
                {
                    key: "ChangeTeamAction",
                    name: "ChangeTeamAction",
                    items: [
                        { 
                            name: "käse",
                            key: "käse"
                        }
                    ]
                }
            ]
        }, "actions")
        .intercept("GET", /.*GetAllInvolvingActions.*/i, r => {
            r.headers["x-hd-test-identifier"] = "actions"
        })
        .visit("http://biehler-josef.de:9500/HD/#/ticket/1")

        cy.get("#actionButton_views\\.Ticket\\.ActionButtons\\.StopEditing")
			.click();
        cy.get("*[id*=stopProcessing_changeTeamTicketAction]")
			.click();

        cy.get("*[data-ui-locator*=reasonWidget] .label")
			.should("contain", "käse");
    })
})
							</code></pre>
						</textarea>
					</section>
				</section>
				<section>
					<section data-markdown>
						<textarea data-template>
							## Mit SPA Frameworks interagieren
							+ drei Fälle: Events werfen & Queue & Events abhören

							<aside class="notes" data-markdown>
								+ Problem erläutern: async, queue, warten auf rendering etc
								+ Aurelia events
							</aside>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Events werfen
							+ Test: Betroffener CI-Kontakt entfernen, wenn CI gelöscht wird
							+ Event simulieren

							<aside class="notes" data-markdown>
								CI zeigen, betroffenen kontakt zeigen, usecase ci löschen
							</aside>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Events werfen

							Code in HD:
							```js
							if (window.Cypress) {
								// EventAggregator ist eine Klasse von uns
								window.eventAggregator = aurelia.container.get(EventAggregator);
							}
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Events werfen

							Test:

							<pre><code data-line-numbers="">
							function publishAureliaEvent(event, data) {
								cy.window().then(win => win.eventAggregator.publish(event, data));
							}
						
							// ticket anlegen mit betroffenen kontakt
							it("test", () => {
								cy.login("developer", "Test12");
								cy.visit("/#/ticket/29")
								cy.get(".calling-card").should("contain", "ci")
								publishAureliaEvent(`entity:configurationitem:deleted:9`, 9);
								cy.get(".calling-card").should("not.contain", "ci")
							})
							</code></pre>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Events werfen - Vorteile
							+ keine Websockets notwendig
							+ Vermeiden von Fehlerquellen
							+ Deterministisches Verhalten
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Fall 2: Queue
							+ Aurelia legt Aktionen in Queue ab
							+ z.b. Rendern von for Schleife
							+ Wann fertig?

							<aside class="notes" data-markdown>
								Kein Beispiel zur Hand, da solche Fälle schwer nachzustellen sind
								Hatte bisher nur zwei Fälle
							</aside>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Fall 2: Queue
							Änderungen an HD:

							```js
							if ((window as any).Cypress) {
								(window as any).aureliaTaskQueue = (window as any).taskQueue =
									DependencyResolver.resolve<TaskQueue>(TaskQueue);
							}
							```

							Funktion in Cypress:
							```js
							function waitForTaskQuue() {
								const randomFieldName = new Date().getTime().toString();
								cy.window().then(win => win.aureliaTaskQueue.queueTask(() => 
									win[randomFieldName] = true));
								cy.window().should(win => 
									expect(win[randomFieldName]).to.equal(true));
							}
							```
						</textarea>
					</section>		
					<section data-markdown>
						<textarea data-template>
							## Events abhören
							+ Bei bestimmten Sachen werden Events geworfen am Client
							+ Beispiel: Tabwechsel
							+ Könnte man das nutzen zur Testunterstützung?
						</textarea>
					</section>	
					<section data-markdown>
						<textarea data-template>
							## Events abhören - Beispiel
							+ Wechsel zu neuem Tickettab
							+ Prüfen, ob korrekter Tab angezeigt wird
						</textarea>
					</section>		
					<section data-markdown>
						<textarea data-template>
							<pre><code data-line-numbers="2-16|18-20|24-27|29|31-34|36">
							function setupEventHandler(event) {
								const container = {};
							
								cy.window({ log: false }).then((win) => {
									cy.log("setup eventhandler for: " + event);
									const handler = (args) => {
										win.document.removeEventListener(event, handler);
										container.event = args;
										container.passed = true;
									};
									win.document.addEventListener(event, handler, false);
								});
							
								return container;
							}
						
							function onTabsChanged() {
								return setupEventHandler("tabsHub:activeTabChanged");
							}
						
							it("tab change fix", () => {
								cy.login("developer", "Test12")
								cy.visit("/#/ticket/1")
									.get("#ticketBaseRoot1 ticket-info");
								cy.visit("/#/ticket/2")
									.get("#ticketBaseRoot2 ticket-info");
						
								const event = onTabsChanged();
						
								cy.window().then(win => {
									win.location
										.replace("http://localhost/HelpdeskApp/#/ticket/1")
								})
							
								cy.wrap(event).should(c => expect(c.passed).to.eq(true))
								cy.get("*[data-active='true'] .tab-text")
									.then($e => expect($e.text().indexOf("1") > -1).eq(true))
							})
							</code></pre>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Events abhören
							Wann kann dies hilfreich sein?

							+ testen, dass etwas nicht passiert zu gegebenen Zeitpunkt
							+ doppelter Timeout (Event + darauf folgender Command!)
							+ Sicherstellen, dass passiert, was man erwartet
							+ Wenn Events getestet werden sollen

							<aside class="notes" data-markdown>
								Events testen: Dass Events ausgelöst werden und man nicht die ganze Kette danach testen möchte
							</aside>
						</textarea>
					</section>
				</section>
				<section>
					<section data-markdown>
						<textarea data-template>
							## Mit OS interagieren
							+ z.b.: Existiert Datei? imap-simple Lib einbinden,...
							+ in Testcase NICHT möglich (logisch, wird im Browser ausgeführt)

							<aside class="notes" data-markdown>
								+ unseren Anwendungsfall erläutern
							</aside>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Mit OS interagieren
							+ Lösung: cy.task()
							+ Beispiel: "doesFileExist"
							+ NodeJS Thread
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## plugin.js

							```js
							const fs = require("fs");

							module.exports = (on, config) => {
								on("task", {
									doesFileExist({ path }) {
										return fs.existsSync(path);
									}
								})
							}
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Test

							```
							describe("task", () => {
								it("test", () => {
									cy.task("doesFileExist", { path: "C:\\Users\\jbiehler\\test.txt" }).then(r => expect(r).eq(true));
								})
							})
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Übung
							+ Task erstellen um cwd auszulesen
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Lösung
							```js
							// plugins
							module.exports = (on, config) => {
								on("task", {
									cwd() {
										return process.cwd()
									}
								})
							}

							// spec
							it("test", () => {
								cy.task("cwd").then(cwd => {
									Cypress.log({
										displayName: "CWD",
										message: "cwd ist " + cwd,
										consoleProps: () => ({
											cwd
										})
									})
								})
							})
							```
						</textarea>
					</section>
				</section>
				<section>
					<section data-markdown>
						<textarea data-template>
							## Achtung vor Instanceof
							+ Problem: HDC Ticketliste testen
							+ Daten (Liste an Tickets) mocken

							<aside class="notes" data-markdown>
								hdc zeigen & erklären
								das war früher ein problem, aber mit inspect() ist es keines mehr
							</aside>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							<pre><code data-line-numbers="3-9|11-16|18-21">
							describe("test", () => {
								beforeEach(() => {
									Cypress.$("body").append(`
									<script>
									document.querySelector("body").arrayObject = [1,2,3]
									</script>
									`)
								})
							
								it("test", () => {
									const array = Cypress.$("body")[0].arrayObject;
									cy.window().then(win => {
										assert.isTrue(array instanceof win.Array)
									})
								})
							
								it("test 2", () => {
									const array = Cypress.$("body")[0].arrayObject;
									assert.isTrue(array instanceof Array);
								})
							})
							</code></pre>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							![](./own_assets/array.png)
						</textarea>
					</section>
				</section>
				<section>
					<section data-markdown>
						<textarea data-template>
							## Chrome Debugger Protocol
							+ Beispiel: "Drucken" Ansicht prüfen
							+ kein Fall für HD, aber privater Natur

							<aside class="notes" data-markdown>
								Das ist jetzt kein Anwendungsfakll im HD
								privater Natur
								aber mächtig! Print, hover, ...
								ALLES was auch mit Chrome Dev Tools machbar ist
							</aside>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Chrome Debugger Protocol
							+ *chrome.exe --remote-debugging-port=9222 --user-data-dir=....*
							+ *C:\Program Files (x86)\Google\Chrome\Application*
							+ *C:\Program Files (x86)\Microsoft\Edge\Application*
							+ Alle debug Ziele: http://localhost:9222/json
							+ WS URL kopieren
							+ Test mit: https://codepen.io/JosefBiehler/pen/gOmmEEr

							<aside class="notes">
								wer das schnell testen möchte, kann ja die befehle mit ausprobieren

							</aside>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							Testbefehl:
							```js
							{
								"id": 1,
								"method": "Page.navigate",
								"params": {
									"url": "https://de.wikipedia.org/wiki/Softwareentwickler"
								}
							}
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Print Mediaquery aktivieren
							```js
							{
								"id": 1,
								"method": "Emulation.setEmulatedMedia",
								"params": { "media": "print" }
							}
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## CDP + Cypress Limits
							+ Nur Chrome unterstützt CDP vollständig
							+ Cypress könnte ebenfalls CDP Session starten (Port Konflikt)
							+ Chrome State resetten

							<aside class="notes" data-markdown>
								Konflikt:
								Kann man mit kleinem Hack fixen (kommt gleich)+
								Resetten:
								Innerhalb einer spec.js Datei bleint der Browserinstanz gleich
								d.h. einmal aktiviert, mus ma das CDP manuel wieder deaktivieren
							</aside>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## CDP + Cypress
							Im Plugins file:
							+ chrome-remote-interface einbinden (macht vieles einfacher)
							+ before:browser:launch event behandeln, um Port zu erhalten & Startargumente zu manipulieren
							+ Tasks für CDP definieren							
							<aside class="notes" data-markdown>
								cdp.spec.js + plugin file
								alles bissl erläutern
							</aside>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							<pre><code data-line-numbers="2|4-15|19-21|24-27|28-34">
							const CDP = require('chrome-remote-interface');

							function ensureRdpPort(args) {
								const existing = args
									.find(arg => arg.slice(0, 23) === '--remote-debugging-port')
							
								if (existing) {
									return Number(existing.split('=')[1])
								}
							
								port = 40000 + Math.round(Math.random() * 25000)
								args.push(`--remote-debugging-port=${port}`)
								return port
							}

							let port, client = null;
							module.exports = (on, config) => {
								on('before:browser:launch', (browser, args) => {
									port = ensureRdpPort(args.args);
								})

								on("task", {
									activatePrintMediaQuery: async () => {
										client = client || await CDP({ port });
										return client.send('Emulation.setEmulatedMedia', { media: "print" })
									},
									resetCRI: async () => {
										if (client) {
											await client.close();
										}

										return Promise.resolve(true);
									}
								})
							}
							</code></pre>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Weitere Anwendungsgebiete von CDP
							+ Native Events absetzen
							+ Hover (CSS) triggern
							+ ....
						</textarea>
					</section>
				</section>
				<section>
					<section data-markdown>
						<textarea data-template>
							## Mehrere Kunden abtesten
							+ wie können mit einem Cypress Projekt unterschiedliche Kundenanforderungen getestet werden?
							+ z.b. Ticket schließen mit/ohne Gründe
							+ versandlabel drucken durch Dienstleister
							<aside class="notes" data-markdown>
								Gründe zeigen
								Konzept der Brands erklären
								Warum wir uns gegen mehrere cypress projekte/unterordner entschieden haben:
								+ shared tests
								+ unübersichtlicher
								+ bei wachsender Brandzahl sehr umfangreich
								+ ...
							</aside>
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Beim Test Attribute angeben
							+ wie können Tests explizit Verhalten in HD steuern?
							+ Classifier ausschalten
							+ ES ausschalten
							+ Websockets deaktivieren
							+ .....
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Tests nur auf bestimmten Environments
							+ wie können Tests nur auf Release ausgeführt werden, nicht aber auf den anderen Systemen
							+ während andere Tests überall ausgeführt werden soll
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Lösung für all das
							+ Steuerung der Tests mittels Tags & Umgebungsvariablen
							+ WICHTIG: ggf Filterung der Testergebnisse!
							+ siehe Code 25.brand-tags.spec.js
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							## Steuern des Verhalten von HD
							+ Authentifizierung
							+ Wechsel der Auth Tokens je nach benötigten Nutzer
							+ Erweiterung des Tagkonzepts

							<aside class="notes" data-markdown>
								+ Speicherung der Tags in einem KOntextobjekt
								+ Übergabe der Tags mittels Header im Request
							</aside>
						</textarea>
					</section>
				</section>
				<section>
					<section data-markdown>
						<textarea data-template>
							## Visuelle Tests
							+ Tacho testen
							+ https://docs.cypress.io/guides/tooling/visual-testing#Functional-vs-visual-testing
							+ Empfehlung: https://github.com/mjhea0/cypress-visual-regression

							<aside class="notes" data-markdown>
								Hab mehrere Libs getestet, aber das war die beste
								Manche haben gar ned funktioniert etc
								Funktionsweise: cy.get(...).snapshot und mit pixeljs etc vergleichen
							</aside>
						</textarea>
					</section>
				</section>
				<section data-markdown>
					<textarea data-template>
						## Stubs & Spies
						+ auch möglich
						+ ersetzen von Date, ...
						+ hatten bisher aber keinen Verwendungszweck
					</textarea>
				</section>
				<section data-markdown>
					<textarea data-template>
						## Tests retry
						+ hilft gegen Flaky Tests
						+ Einfacher Parameter in npm script
						+ Achtung: "State zwischen Tests" Problem!
					</textarea>
				</section>
				<section data-markdown>
					<textarea data-template>
						## Dashboard
						![](./own_assets/dashboard.jpg)
					</textarea>
				</section>
				<section data-markdown>
					<textarea data-template>
						## Cypress Studio
						+ Interaktion auf Seite als Test speichern
						+ geht derzeit nicht mit Firstanswer HD
						+ https://docs.cypress.io/guides/core-concepts/cypress-studio
						+ siehe Demo

						<aside class="notes">
							mit google.de geht es
						</aside>
					</textarea>
				</section>
				<section data-markdown>
					<textarea data-template>
						## Before/after run/spec events
						+ https://docs.cypress.io/api/plugins/before-run-api
						+ https://docs.cypress.io/api/plugins/after-run-api
						+ https://docs.cypress.io/api/plugins/before-spec-api
						+ https://docs.cypress.io/api/plugins/after-spec-api
					</textarea>
				</section>
				<section>
					<section data-markdown>
						<textarea data-template>
							## Automatisierungen
							+ Cypress kann noch mehr
							+ Crawlen von Slack
							+ https://github.com/gabbersepp/slack-crawler

							<aside class="notes">
								besser als puppeteer, da wait etc automatisch
							</aside>
						</textarea>
					</section>
				</section>
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
			});
		</script>
	</body>
</html>
